schema: asvk.topology/1.0
meta:
  {
    id: lab5-static,
    title: "Настройка статических маршрутов и маршрутов по умолчанию",
  }

provider: { name: virtualbox }

defaults:
  routing: { stack: bird } # по умолчанию BIRD

networks:
  - { id: lan12, type: l2 }
  - { id: lan13, type: l2 }
  - { id: lan23, type: l2 }

nodes:
  - name: R1
    role: router
    interfaces:
      - { name: eth1, network: lan13, addresses: ["10.0.13.1/24"] }
      - { name: eth2, network: lan12, addresses: ["10.0.12.1/24"] }
      - { name: lo, loopback: true, addresses: ["10.0.1.1/24"] }
    routing:
      protocols:
        static:
          routes:
            - { to: "10.0.3.0/24", via: "10.0.13.3" }
            - { to: "0.0.0.0/0", via: "10.0.13.3" }

  - name: R2
    role: router
    interfaces:
      - { name: eth1, network: lan12, addresses: ["10.0.12.2/24"] }
      - { name: eth2, network: lan23, addresses: ["10.0.23.2/24"] }
      - { name: lo, loopback: true, addresses: ["10.0.2.2/24"] }
    routing:
      stack: bird
      protocols:
        static:
          routes:
            - { to: "10.0.13.0/24", via: "10.0.23.3" }
            - { to: "10.0.3.0/24", via: "10.0.23.3" }

  - name: R3
    role: router
    interfaces:
      - { name: eth1, network: lan13, addresses: ["10.0.13.3/24"] }
      - { name: eth2, network: lan23, addresses: ["10.0.23.3/24"] }
      - { name: lo, loopback: true, addresses: ["10.0.3.3/24"] }
    routing: { stack: linux }

profiles:
  - name: "R2-static-via-FRR"
    description: "Only on R2, static routes are generated by FRR (for uniform show)"
    patches:
      - op: replace
        path: /nodes/1/routing/stack # nodes[1] is R2
        value: frr

tests:
  - { name: ping-R1->R3-via-R3, from: R1, to: 10.0.23.3, expect: success }
  - { name: traceroute-R1->R3, from: R1, to: 10.0.3.3, expect: "via 10.0.13.3" }
